---
- name: Create dolt data directory
  ansible.builtin.file:
    path: "{{ dolt_data_dir }}"
    state: directory
    mode: "0755"

- name: Create systemd user service directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.config/systemd/user"
    state: directory
    mode: "0755"

- name: Deploy dolt start script
  ansible.builtin.template:
    src: dolt-start.sh.j2
    dest: "{{ ansible_env.HOME }}/.config/systemd/skogai-dolt-start.sh"
    mode: "0755"

- name: Deploy dolt systemd user service
  ansible.builtin.template:
    src: dolt-server.service.j2
    dest: "{{ ansible_env.HOME }}/.config/systemd/user/skogai-dolt.service"
    mode: "0644"

- name: Set dolt global user.name
  ansible.builtin.command:
    cmd: dolt config --global --set user.name {{ dolt_user_name }}
  changed_when: false

- name: Set dolt global user.email
  ansible.builtin.command:
    cmd: dolt config --global --set user.email {{ dolt_user_email }}
  changed_when: false

- name: Reload systemd user daemon
  ansible.builtin.systemd:
    daemon_reload: true
    scope: user

- name: Enable and start dolt server
  ansible.builtin.systemd:
    name: skogai-dolt
    state: started
    enabled: true
    scope: user
